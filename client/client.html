<!DOCTYPE html>
<html>
<head>
    <title>Enregistrement Audio</title>
</head>
<body>
<h1>Enregistrement Audio</h1>
<button id="startRecordingButton">Commencer l'enregistrement</button>
<button id="stopRecordingButton" disabled>Arrêter l'enregistrement</button>

<script>
    let websocket;
    let chunks = [];

    const audioStreamConstraints = { audio: true };
    const mediaRecorderOptions = { mimeType: 'audio/webm' };

    const startRecordingButton = document.getElementById('startRecordingButton');
    const stopRecordingButton = document.getElementById('stopRecordingButton');
    let audioContext = new (window.AudioContext || window.webkitAudioContext)();

    var mediaRecorder;
    var streamGlobal;

    startRecordingButton.addEventListener('click', () => {
        startRecordingButton.disabled = true;
        stopRecordingButton.disabled = false;

        navigator.mediaDevices.getUserMedia(audioStreamConstraints)
            .then(stream => {
                // Établir la connexion WebSocket avec le serveur
                websocket = new WebSocket('ws://localhost:8080/');

                websocket.onmessage = function(event) {
                    // Récupérer les données audio reçues du serveur
                    const audioData = event.data;
                    // Jouer le son reçu du serveur
                    playAudioFromServer(audioData);
                };

                streamGlobal = stream
                grosSex()

                // Vous pouvez ajuster la durée des morceaux audio ici
            })
            .catch(error => console.error('Erreur lors de la capture audio : ', error));
    });

    async function grosSex() {
        mediaRecorder = new MediaRecorder(streamGlobal, mediaRecorderOptions);

        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                chunks.push(event.data);
                console.log("Sending")
                console.log(event.data)
                const blob = new Blob(chunks, { type: 'audio/webm' });
                websocket.send(blob);
                chunks = [];
                mediaRecorder.ondataavailable = (event) => {
                };
                mediaRecorder.stop();
                grosSex()
            }
        };
        mediaRecorder.start(200);
    }

    async function sex() {
        setInterval(() => {
            stop();
            mediaRecorder = new MediaRecorder(streamGlobal, mediaRecorderOptions);

            mediaRecorder.ondataavailable = async function(event) {
                if (event.data.size > 0) {
                    chunks.push(event.data);
                    console.log("Sending")
                    console.log(event.data)
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    websocket.send(blob);
                    chunks = [];
                    stop()
                }
            };
            mediaRecorder.start(200);
        }, 200);
    }

    async function stop() {
        mediaRecorder.ondataavailable = (event) => {
        };
        mediaRecorder.stop();
    }

    function playAudioFromServer(audioData) {
        if (audioData instanceof Blob) {
            const reader = new FileReader();
            reader.onload = function() {
                const arrayBuffer = reader.result;
                audioContext.decodeAudioData(arrayBuffer, function(buffer) {
                    console.log(buffer)
                    const audioSource = audioContext.createBufferSource();
                    audioSource.buffer = buffer;
                    audioSource.connect(audioContext.destination);
                    audioSource.start();
                }, function(error) {
                    console.error('Erreur lors du décodage des données audio:', error);
                });
            };
            reader.readAsArrayBuffer(audioData);
        }
    }

    stopRecordingButton.addEventListener('click', () => {
        stopRecordingButton.disabled = true;
        mediaRecorder.stop();
        startRecordingButton.disabled = false;
    });

</script>
</body>
</html>
